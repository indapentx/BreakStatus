<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Trend ISG Access</title>

    <script defer src="/__/firebase/12.5.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/12.5.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <style>
      :root {
        color: #000;
        background-color: #fff;
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #0a0a0a;
        color: #111;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }

      main {
        width: min(520px, 100%);
        background: #fdfdfd;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.45);
      }

      header {
        margin-bottom: 28px;
      }

      .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.75rem;
        margin: 0 0 10px;
        color: #555;
      }

      h1 {
        margin: 0 0 8px;
        font-size: 1.8rem;
        color: #0b0b0b;
      }

      .subtitle {
        margin: 0;
        font-size: 0.95rem;
        color: #444;
        line-height: 1.5;
      }

      .mode-switcher {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 24px;
      }

      .mode-switcher button {
        border-radius: 999px;
        border: 1px solid #111;
        background: #f5f5f5;
        color: #111;
        padding: 10px 12px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .mode-switcher button.active {
        background: #111;
        color: #fdfdfd;
      }

      .mode-switcher button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #0f0f0f;
        margin-bottom: 6px;
        display: block;
      }

      input {
        width: 100%;
        border: 1px solid #cfcfcf;
        border-radius: 12px;
        padding: 14px 16px;
        font-size: 1rem;
        background: #f8f8f8;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      }

      input:focus {
        outline: none;
        border-color: #000;
        background: #fff;
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.15);
      }

      input:disabled {
        background: #e9e9e9;
        cursor: not-allowed;
      }

      button.primary {
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        padding: 15px 18px;
        background: #111;
        color: #fefefe;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      button.primary:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      }

      button.primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .feedback {
        margin: 18px 0 0;
        min-height: 1.4em;
        font-size: 0.95rem;
        color: #333;
      }

      .feedback.hidden {
        display: none;
      }

      .feedback.is-error {
        color: #000;
        font-weight: 600;
      }

      .feedback.is-success {
        color: #111;
        font-weight: 600;
      }

      .feedback.is-info {
        color: #555;
        font-style: italic;
      }

      .authed {
        margin-top: 24px;
        padding: 18px;
        border-radius: 16px;
        border: 1px solid #d9d9d9;
        background: #f4f4f4;
      }

      .authed p {
        margin: 0;
        font-weight: 500;
        color: #111;
      }

      .authed-buttons {
        margin-top: 14px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .authed-buttons button {
        flex: 1 1 160px;
      }

      button.ghost {
        border-radius: 12px;
        border: 1px solid #111;
        background: transparent;
        color: #111;
        padding: 15px 18px;
        font-weight: 600;
        cursor: pointer;
      }

      button.ghost:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .hidden {
        display: none !important;
      }

      form[data-mode="signin"] .confirm-group,
      form[data-mode="reset"] .password-group,
      form[data-mode="reset"] .confirm-group {
        display: none;
      }

      @media (max-width: 560px) {
        body {
          padding: 16px;
        }

        main {
          padding: 28px;
        }

        .mode-switcher {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body data-destination="/">
    <main role="main">
      <header>
        <p class="eyebrow">Trend ISG</p>
        <h1 id="modeTitle">Sign in</h1>
        <p id="modeCopy" class="subtitle">Use your credentials to continue.</p>
      </header>

      <div class="mode-switcher" role="tablist" aria-label="Authentication mode">
        <button type="button" data-mode-button data-mode="signin" aria-pressed="true">Sign in</button>
        <button type="button" data-mode-button data-mode="signup" aria-pressed="false">Create account</button>
        <button type="button" data-mode-button data-mode="reset" aria-pressed="false">Reset password</button>
      </div>

      <form id="authForm" data-mode="signin" autocomplete="on" novalidate>
        <div class="field-group">
          <label for="email">Email address</label>
          <input id="email" name="email" type="email" autocomplete="email" placeholder="you@trendisg.com" required>
        </div>
        <div class="field-group password-group">
          <label for="password">Password</label>
          <input id="password" name="password" type="password" autocomplete="current-password" placeholder="Enter your password" minlength="6">
        </div>
        <div class="field-group confirm-group">
          <label for="confirmPassword">Confirm password</label>
          <input id="confirmPassword" name="confirmPassword" type="password" autocomplete="new-password" placeholder="Re-enter your password" minlength="6">
        </div>
        <button class="primary" id="submitBtn" type="submit">Sign in</button>
      </form>

      <p id="feedback" class="feedback hidden" role="status" aria-live="polite"></p>

      <div id="authedActions" class="authed hidden" aria-live="polite">
        <p id="authedEmail"></p>
        <div class="authed-buttons">
          <button class="primary" id="enterSiteButton" type="button" disabled>Enter site</button>
          <button class="ghost" id="signOutButton" type="button" disabled>Sign out</button>
        </div>
      </div>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        if (!window.firebase || !firebase.apps.length) {
          console.error('Firebase failed to initialize. Check init.js.');
          return;
        }

        const modeSettings = {
          signin: {
            title: 'Sign in',
            copy: 'Use your existing credentials to enter the site.',
            button: 'Sign in',
            pending: 'Signing in...'
          },
          signup: {
            title: 'Create account',
            copy: 'Provision a new Trend ISG account with email and password.',
            button: 'Create account',
            pending: 'Creating account...'
          },
          reset: {
            title: 'Reset password',
            copy: 'We will email you a reset link for your account.',
            button: 'Send reset link',
            pending: 'Sending reset email...'
          }
        };

        const auth = firebase.auth();
        const authForm = document.getElementById('authForm');
        const modeTitle = document.getElementById('modeTitle');
        const modeCopy = document.getElementById('modeCopy');
        const emailField = document.getElementById('email');
        const passwordField = document.getElementById('password');
        const confirmField = document.getElementById('confirmPassword');
        const submitBtn = document.getElementById('submitBtn');
        const modeButtons = Array.from(document.querySelectorAll('[data-mode-button]'));
        const feedbackEl = document.getElementById('feedback');
        const authedActions = document.getElementById('authedActions');
        const authedEmail = document.getElementById('authedEmail');
        const enterButton = document.getElementById('enterSiteButton');
        const signOutButton = document.getElementById('signOutButton');

        const redirectParam = new URLSearchParams(window.location.search).get('redirect');
        let destination = document.body.dataset.destination || '/';

        if (redirectParam) {
          try {
            const target = new URL(redirectParam, window.location.origin);
            if (target.origin === window.location.origin) {
              destination = target.pathname + target.search + target.hash;
            }
          } catch (error) {
            console.warn('Ignoring invalid redirect parameter', error);
          }
        }

        const variants = ['error', 'success', 'info'];
        let currentMode = 'signin';
        let isLoading = false;

        const setFeedback = (message, variant) => {
          variants.forEach(type => feedbackEl.classList.remove('is-' + type));
          if (!message) {
            feedbackEl.textContent = '';
            feedbackEl.classList.add('hidden');
            return;
          }

          feedbackEl.textContent = message;
          feedbackEl.classList.remove('hidden');
          if (variant && variants.includes(variant)) {
            feedbackEl.classList.add('is-' + variant);
          }
        };

        const applyFieldAvailability = () => {
          emailField.disabled = isLoading;
          passwordField.disabled = isLoading || currentMode === 'reset';
          confirmField.disabled = isLoading || currentMode !== 'signup';
          passwordField.required = currentMode !== 'reset';
          confirmField.required = currentMode === 'signup';
        };

        const setMode = (mode, options = {}) => {
          if (!modeSettings[mode]) {
            return;
          }

          currentMode = mode;
          authForm.dataset.mode = mode;
          modeTitle.textContent = modeSettings[mode].title;
          modeCopy.textContent = modeSettings[mode].copy;
          passwordField.setAttribute('autocomplete', mode === 'signup' ? 'new-password' : 'current-password');
          if (!isLoading) {
            submitBtn.textContent = modeSettings[mode].button;
          }

          modeButtons.forEach(btn => {
            const active = btn.dataset.mode === mode;
            btn.classList.toggle('active', active);
            btn.setAttribute('aria-pressed', active);
          });

          if (!isLoading) {
            passwordField.value = '';
            confirmField.value = '';
          }

          if (!options.preserveFeedback) {
            setFeedback('');
          }

          applyFieldAvailability();
        };

        const setLoading = (state) => {
          isLoading = state;
          submitBtn.disabled = state;
          modeButtons.forEach(btn => {
            btn.disabled = state;
          });
          submitBtn.textContent = state ? modeSettings[currentMode].pending : modeSettings[currentMode].button;
          applyFieldAvailability();
        };

        modeButtons.forEach(btn => {
          btn.addEventListener('click', function () {
            if (isLoading) {
              return;
            }
            setMode(btn.dataset.mode);
          });
        });

        const readableError = (error) => {
          if (!error || !error.code) {
            return error && error.message ? error.message : 'Unable to complete the request.';
          }

          switch (error.code) {
            case 'auth/email-already-in-use':
              return 'That email is already in use.';
            case 'auth/invalid-email':
              return 'Enter a valid email address.';
            case 'auth/operation-not-allowed':
              return 'This operation is currently unavailable.';
            case 'auth/user-disabled':
              return 'This account has been disabled.';
            case 'auth/user-not-found':
              return 'No account found for that email.';
            case 'auth/wrong-password':
              return 'The password you entered is incorrect.';
            case 'auth/weak-password':
              return 'Use at least six characters for your password.';
            case 'auth/too-many-requests':
              return 'Too many attempts. Please wait and try again.';
            default:
              return error.message.replace('Firebase: ', '');
          }
        };

        authForm.addEventListener('submit', function (event) {
          event.preventDefault();
          if (isLoading) {
            return;
          }

          const email = emailField.value.trim();
          const password = passwordField.value;
          const confirmPassword = confirmField.value;

          if (!email) {
            setFeedback('Enter an email address.', 'error');
            return;
          }

          if (currentMode !== 'reset' && !password) {
            setFeedback('Enter your password.', 'error');
            return;
          }

          if (currentMode === 'signup' && password !== confirmPassword) {
            setFeedback('Passwords must match.', 'error');
            return;
          }

          setLoading(true);
          setFeedback(modeSettings[currentMode].pending, 'info');

          let action;
          if (currentMode === 'signin') {
            action = auth.signInWithEmailAndPassword(email, password);
          } else if (currentMode === 'signup') {
            action = auth.createUserWithEmailAndPassword(email, password);
          } else {
            action = auth.sendPasswordResetEmail(email);
          }

          action.then(function () {
            if (currentMode === 'reset') {
              setFeedback('If an account exists for that email, a reset link was sent.', 'success');
              authForm.reset();
              setMode('signin', { preserveFeedback: true });
            }

            if (currentMode === 'signup') {
              setFeedback('Account created. You can now enter the site.', 'success');
            }
          }).catch(function (error) {
            setFeedback(readableError(error), 'error');
          }).finally(function () {
            setLoading(false);
          });
        });

        auth.onAuthStateChanged(function (user) {
          const isSignedIn = Boolean(user);
          authedActions.classList.toggle('hidden', !isSignedIn);
          enterButton.disabled = !isSignedIn;
          signOutButton.disabled = !isSignedIn;

          if (isSignedIn) {
            authedEmail.textContent = user.email ? 'Signed in as ' + user.email : 'Signed in.';
            setFeedback('Authenticated. Continue when ready.', 'success');
          } else {
            authForm.reset();
            setMode('signin');
            setFeedback('');
          }
        });

        enterButton.addEventListener('click', function () {
          enterButton.disabled = true;
          window.location.assign(destination);
        });

        signOutButton.addEventListener('click', function () {
          signOutButton.disabled = true;
          setFeedback('Signing out...', 'info');

          auth.signOut().catch(function (error) {
            setFeedback(readableError(error), 'error');
            signOutButton.disabled = false;
          });
        });

        setMode('signin');
      });
    </script>
  </body>
</html>
