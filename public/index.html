<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bus Status</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light;
        --bg: #ffffff;
        --surface: #f4f4f4;
        --card: #ffffff;
        --text: #111111;
        --subtle: #6b6b6b;
        --border: #e3e3e3;
        --accent: #111111;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        margin: 0;
        padding: 2rem 1.5rem 3rem;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        justify-content: center;
      }

      main {
        width: min(960px, 100%);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      header {
        text-align: left;
      }

      h1 {
        margin: 0 0 0.35rem;
        font-size: clamp(2rem, 4vw, 2.5rem);
        letter-spacing: -0.02em;
      }

      header p {
        margin: 0;
        color: var(--subtle);
        max-width: 52ch;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 1.75rem;
        box-shadow: 0 20px 40px rgba(17, 17, 17, 0.03);
      }

      .auth-card form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      label {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--subtle);
      }

      input {
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 0.85rem 1.1rem;
        font-size: 1rem;
        background: var(--surface);
        color: var(--text);
      }

      input:focus-visible {
        outline: 2px solid var(--text);
        outline-offset: 2px;
      }

      .form-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      button {
        border: none;
        border-radius: 999px;
        padding: 0.85rem 1.4rem;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        background: var(--accent);
        color: var(--bg);
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      button.ghost {
        background: transparent;
        color: var(--text);
        border: 1px solid var(--border);
      }

      button:disabled {
        opacity: 0.35;
        cursor: not-allowed;
      }

      button:not(:disabled):hover {
        opacity: 0.9;
      }

      .muted {
        color: var(--subtle);
        font-size: 0.9rem;
        margin-top: 0.25rem;
        min-height: 1.25rem;
      }

      .muted.error {
        color: #b3261e;
      }

      .dashboard {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .user-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }

      .eyebrow {
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.15em;
        color: var(--subtle);
        margin: 0;
      }

      .user-email {
        margin: 0.25rem 0 0;
        font-size: 1.35rem;
        font-weight: 600;
      }

      .lists {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1rem;
      }

      .list-column {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1.2rem;
        background: var(--surface);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
      }

      h2 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: -0.01em;
      }

      .status-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .status-list li {
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--card);
        padding: 0.9rem 1rem;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
        align-items: center;
      }

      .status-list .empty {
        color: var(--subtle);
        font-weight: 400;
        font-size: 0.95rem;
      }

      .time-badge {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--subtle);
      }

      .hidden {
        display: none;
      }

      @media (max-width: 640px) {
        body {
          padding: 1.25rem;
        }

        .form-actions {
          flex-direction: column;
        }

        .user-row {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <h1>Bus Status</h1>
        <p>
          Minimal, light-first attendance tracker. Sign in with email, then toggle
          whether you are on the bus. Every join snapshot keeps the time stamp
          so everyone stays in sync.
        </p>
      </header>

      <section class="card auth-card" id="auth-card">
        <form id="auth-form" autocomplete="on">
          <label>
            Email
            <input type="email" id="email" name="email" placeholder="you@email.com" required />
          </label>
          <label>
            Password
            <input
              type="password"
              id="password"
              name="password"
              minlength="6"
              placeholder="Minimum 6 characters"
              required
            />
          </label>
          <div class="form-actions">
            <button type="submit" name="action" value="signin">Sign In</button>
            <button type="submit" name="action" value="register" class="ghost">
              Create Account
            </button>
          </div>
        </form>
        <p class="muted" id="auth-message">
          Email + password auth is powered by Firebase. Add your project config before deploying.
        </p>
      </section>

      <section class="card dashboard hidden" id="dashboard">
        <div class="user-row">
          <div>
            <p class="eyebrow">Signed in as</p>
            <p class="user-email" id="user-email">—</p>
          </div>
          <button class="ghost" id="sign-out">Sign Out</button>
        </div>

        <div class="lists">
          <div class="list-column">
            <div class="list-header">
              <h2>On the bus</h2>
              <button id="leave-btn" class="ghost" type="button" disabled>Leave list</button>
            </div>
            <ul class="status-list" id="on-bus">
              <li class="empty">Sign in to see the roster.</li>
            </ul>
          </div>
          <div class="list-column">
            <div class="list-header">
              <h2>Not on the bus</h2>
              <button id="join-btn" type="button" disabled>Join bus</button>
            </div>
            <ul class="status-list" id="off-bus">
              <li class="empty">Sign in to see the roster.</li>
            </ul>
          </div>
        </div>
        <p class="muted" id="roster-message"></p>
      </section>
    </main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        onSnapshot,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDHZz5fVOTvnokTuTUjNSC5QSiC7mFxyZM",
        authDomain: "trend-isg.firebaseapp.com",
        projectId: "trend-isg",
        storageBucket: "trend-isg.firebasestorage.app",
        messagingSenderId: "751472868865",
        appId: "1:751472868865:web:eb6702b74236d19913ca00",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const rosterCollection = collection(db, "busRoster");

      const authCard = document.getElementById("auth-card");
      const dashboard = document.getElementById("dashboard");
      const authForm = document.getElementById("auth-form");
      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const authMessage = document.getElementById("auth-message");
      const rosterMessage = document.getElementById("roster-message");
      const joinButton = document.getElementById("join-btn");
      const leaveButton = document.getElementById("leave-btn");
      const onBusList = document.getElementById("on-bus");
      const offBusList = document.getElementById("off-bus");
      const userEmailEl = document.getElementById("user-email");
      const signOutButton = document.getElementById("sign-out");

      let currentUser = null;
      let rosterEntries = [];
      let rosterUnsubscribe = null;
      let selfEntry = null;
      let isRosterMutating = false;

      function toggleViews(isSignedIn) {
        if (isSignedIn) {
          authCard.classList.add("hidden");
          dashboard.classList.remove("hidden");
        } else {
          authCard.classList.remove("hidden");
          dashboard.classList.add("hidden");
        }
      }

      function setAuthMessage(message, isError = false) {
        authMessage.textContent = message;
        authMessage.classList.toggle("error", isError);
      }

      function setRosterMessage(message = "", isError = false) {
        if (!rosterMessage) return;
        rosterMessage.textContent = message;
        rosterMessage.classList.toggle("error", isError);
      }

      function toDate(value) {
        if (!value) return null;
        if (typeof value.toDate === "function") {
          try {
            return value.toDate();
          } catch {
            return null;
          }
        }
        const date = new Date(value);
        return Number.isNaN(date.getTime()) ? null : date;
      }

      function getTimestampValue(value) {
        const date = toDate(value);
        return date ? date.getTime() : Number.MAX_SAFE_INTEGER;
      }

      function formatTime(value) {
        const date = toDate(value);
        if (!date) return "--:--";
        try {
          return new Intl.DateTimeFormat([], {
            hour: "numeric",
            minute: "2-digit",
          }).format(date);
        } catch {
          return "--:--";
        }
      }

      function updateActionButtons() {
        if (!currentUser) {
          joinButton.disabled = true;
          leaveButton.disabled = true;
          return;
        }
        const entry =
          rosterEntries.find((record) => record.id === currentUser.uid) ?? selfEntry;
        const isOnBus = Boolean(entry?.isOnBus);
        joinButton.disabled = isRosterMutating || isOnBus;
        leaveButton.disabled = isRosterMutating || !isOnBus;
      }

      function createListItem(entry, { showJoinedAt = false } = {}) {
        const li = document.createElement("li");
        const emailSpan = document.createElement("span");
        emailSpan.textContent = entry.email ?? "Unknown rider";
        li.appendChild(emailSpan);

        if (showJoinedAt && entry.joinedAt) {
          const timeSpan = document.createElement("span");
          timeSpan.className = "time-badge";
          timeSpan.textContent = formatTime(entry.joinedAt);
          li.appendChild(timeSpan);
        }

        return li;
      }

      function populateList(target, entries, emptyText, options = {}) {
        if (!entries.length) {
          target.innerHTML = `<li class="empty">${emptyText}</li>`;
          return;
        }
        const fragment = document.createDocumentFragment();
        entries.forEach((entry) => {
          fragment.appendChild(createListItem(entry, options));
        });
        target.replaceChildren(fragment);
      }

      function renderLists() {
        if (!currentUser) {
          onBusList.innerHTML = '<li class="empty">Sign in to see the roster.</li>';
          offBusList.innerHTML = '<li class="empty">Sign in to see the roster.</li>';
          updateActionButtons();
          return;
        }

        const onBusEntries = rosterEntries.filter((entry) => entry.isOnBus);
        const offBusEntries = rosterEntries.filter((entry) => !entry.isOnBus);

        const onBusSorted = [...onBusEntries].sort(
          (a, b) => getTimestampValue(a.joinedAt) - getTimestampValue(b.joinedAt)
        );
        const offBusSorted = [...offBusEntries].sort((a, b) =>
          (a.email ?? "").localeCompare(b.email ?? "", undefined, { sensitivity: "base" })
        );

        populateList(onBusList, onBusSorted, "Nobody is on the bus right now.", {
          showJoinedAt: true,
        });
        populateList(offBusList, offBusSorted, "Everyone is already on board.");
        updateActionButtons();
      }

      async function ensureRosterEntry(user) {
        const ref = doc(db, "busRoster", user.uid);
        try {
          const snapshot = await getDoc(ref);
          if (!snapshot.exists()) {
            const seed = {
              email: user.email,
              isOnBus: false,
              joinedAt: null,
              updatedAt: serverTimestamp(),
            };
            await setDoc(ref, seed);
            selfEntry = { id: user.uid, ...seed };
          } else {
            selfEntry = { id: user.uid, ...snapshot.data() };
          }
          updateActionButtons();
        } catch (error) {
          console.error("Unable to prepare roster entry", error);
          setRosterMessage("Unable to prepare your roster slot.", true);
        }
      }

      function startRosterSubscription() {
        if (rosterUnsubscribe) return;
        rosterUnsubscribe = onSnapshot(
          rosterCollection,
          (snapshot) => {
            rosterEntries = snapshot.docs.map((docSnap) => ({
              id: docSnap.id,
              ...docSnap.data(),
            }));
            if (currentUser) {
              const latestSelf = rosterEntries.find((entry) => entry.id === currentUser.uid);
              if (latestSelf) {
                selfEntry = latestSelf;
              }
            }
            renderLists();
          },
          (error) => {
            console.error("Roster listener error", error);
            setRosterMessage("Live roster updates paused. Refresh the page.", true);
          }
        );
      }

      function stopRosterSubscription() {
        if (rosterUnsubscribe) {
          rosterUnsubscribe();
          rosterUnsubscribe = null;
        }
        rosterEntries = [];
        selfEntry = null;
        renderLists();
      }

      async function updateBusStatus(targetState) {
        if (!currentUser || isRosterMutating) return;
        isRosterMutating = true;
        updateActionButtons();
        setRosterMessage(targetState ? "Joining the bus…" : "Leaving the bus…");

        const optimisticEntry = {
          id: currentUser.uid,
          email: currentUser.email,
          isOnBus: targetState,
          joinedAt: targetState ? new Date() : null,
        };
        const index = rosterEntries.findIndex((entry) => entry.id === currentUser.uid);
        if (index >= 0) {
          rosterEntries[index] = { ...rosterEntries[index], ...optimisticEntry };
        } else {
          rosterEntries = [...rosterEntries, optimisticEntry];
        }
        selfEntry = optimisticEntry;
        renderLists();

        try {
          await setDoc(
            doc(db, "busRoster", currentUser.uid),
            {
              email: currentUser.email,
              isOnBus: targetState,
              joinedAt: targetState ? serverTimestamp() : null,
              updatedAt: serverTimestamp(),
            },
            { merge: true }
          );
          setRosterMessage(targetState ? "You are on the bus." : "You left the bus.");
        } catch (error) {
          console.error("Roster update failed", error);
          setRosterMessage("Update failed. Please try again.", true);
        } finally {
          isRosterMutating = false;
          updateActionButtons();
        }
      }

      authForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        const action = event.submitter?.value ?? "signin";

        if (!email || !password) {
          setAuthMessage("Enter an email and a password.", true);
          return;
        }

        try {
          if (action === "register") {
            setAuthMessage("Creating your account…");
            await createUserWithEmailAndPassword(auth, email, password);
            setAuthMessage("Account created. Signing you in…");
          } else {
            setAuthMessage("Signing you in…");
            await signInWithEmailAndPassword(auth, email, password);
            setAuthMessage("Signed in.");
          }
        } catch (error) {
          const friendly =
            typeof error?.code === "string"
              ? error.code.replace("auth/", "").replace(/-/g, " ")
              : "Something went wrong. Try again.";
          setAuthMessage(friendly, true);
        }
      });

      joinButton.addEventListener("click", () => updateBusStatus(true));
      leaveButton.addEventListener("click", () => updateBusStatus(false));

      signOutButton.addEventListener("click", async () => {
        try {
          await signOut(auth);
          setAuthMessage("Signed out.");
        } catch {
          setAuthMessage("Unable to sign out. Try again.", true);
        }
      });

      onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (user) {
          userEmailEl.textContent = user.email;
          setRosterMessage("");
          await ensureRosterEntry(user);
          startRosterSubscription();
        } else {
          userEmailEl.textContent = "—";
          setRosterMessage("");
          stopRosterSubscription();
        }
        toggleViews(Boolean(user));
        renderLists();
      });

      renderLists();
    </script>
  </body>
</html>
