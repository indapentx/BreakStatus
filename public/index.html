<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Trend ISG · Bus Board</title>

    <script defer src="/__/firebase/12.5.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/12.5.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/12.5.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <style>
      :root {
        color-scheme: light;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: #f4f4f4;
        color: #0f0f0f;
        font-size: 16px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 40px 16px 60px;
      }

      main.layout {
        width: min(440px, 100%);
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      body.is-authed main.layout {
        width: min(960px, 100%);
      }

      .panel {
        width: 100%;
        background: #fff;
        border: 1px solid #e4e4e4;
        border-radius: 20px;
        padding: clamp(24px, 4vw, 36px);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.06);
      }

      .panel h1,
      .panel h2,
      .panel p {
        margin: 0;
      }

      .hidden {
        display: none !important;
      }

      /* Auth */
      .auth-panel header {
        margin-bottom: 16px;
      }

      .auth-panel header h1 {
        font-size: 1.35rem;
        margin-bottom: 6px;
      }

      .tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 16px;
      }

      .tabs button {
        flex: 1;
        border: 1px solid #cfcfcf;
        border-radius: 999px;
        background: #f8f8f8;
        padding: 10px 12px;
        font-weight: 600;
        cursor: pointer;
        color: #0f0f0f;
      }

      .tabs button.active {
        background: #0f0f0f;
        color: #fff;
        border-color: #0f0f0f;
      }

      .tabs button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #111;
        margin-bottom: 4px;
        display: block;
      }

      input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid #dcdcdc;
        font-size: 1rem;
        background: #fbfbfb;
      }

      input:focus {
        outline: none;
        border-color: #111;
        background: #fff;
      }

      input:disabled {
        background: #ededed;
        cursor: not-allowed;
      }

      .primary-btn {
        border: none;
        border-radius: 12px;
        padding: 14px 18px;
        font-size: 1rem;
        font-weight: 600;
        background: #111;
        color: #fff;
        cursor: pointer;
      }

      .primary-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .feedback {
        min-height: 1.4em;
        font-size: 0.92rem;
        color: #444;
      }

      .feedback.hidden {
        display: none;
      }

      .feedback.is-error {
        color: #000;
        font-weight: 600;
      }

      .feedback.is-success {
        color: #111;
        font-weight: 600;
      }

      .feedback.is-info {
        color: #555;
        font-style: italic;
      }

      form[data-mode="signin"] .confirm-field,
      form[data-mode="reset"] .password-field,
      form[data-mode="reset"] .confirm-field {
        display: none;
      }

      /* Board */
      .board-panel header {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 20px;
      }

      @media (min-width: 640px) {
        .board-panel header {
          flex-direction: row;
          align-items: baseline;
          justify-content: space-between;
        }
      }

      .board-panel h1 {
        font-size: 1.35rem;
      }

      .board-panel small {
        color: #555;
      }

      .board-grid {
        display: grid;
        gap: 16px;
      }

      @media (min-width: 640px) {
        .board-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      .list-card {
        border: 1px solid #e3e3e3;
        border-radius: 12px;
        padding: 16px;
        min-height: 220px;
        display: flex;
        flex-direction: column;
      }

      .list-card h2 {
        font-size: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 12px;
        color: #111;
      }

      ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      li {
        padding: 6px 0;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.95rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      li:last-child {
        border-bottom: none;
      }

      .dim-text {
        color: #666;
        font-size: 0.85rem;
      }

      .actions {
        margin-top: 18px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .actions button {
        flex: 1 1 160px;
      }

      .ghost-btn {
        border-radius: 12px;
        border: 1px solid #111;
        background: transparent;
        padding: 12px 16px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
      }

      .ghost-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      #boardFeedback {
        margin-top: 12px;
        font-size: 0.92rem;
        color: #333;
      }
    </style>
  </head>
  <body class="is-guest">
    <main class="layout">
      <section id="authPanel" class="panel auth-panel">
        <header>
          <h1>Access Trend ISG</h1>
          <p>Sign in, create an account, or request a reset.</p>
        </header>

        <div class="tabs" role="tablist" aria-label="Auth mode">
          <button type="button" data-mode-button data-mode="signin" aria-pressed="true">Sign in</button>
          <button type="button" data-mode-button data-mode="signup" aria-pressed="false">Create</button>
          <button type="button" data-mode-button data-mode="reset" aria-pressed="false">Reset</button>
        </div>

        <form id="authForm" data-mode="signin" novalidate>
          <div class="field-group">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" autocomplete="email" required placeholder="you@trendisg.com">
          </div>
          <div class="field-group password-field">
            <label for="password">Password</label>
            <input id="password" name="password" type="password" autocomplete="current-password" minlength="6" placeholder="Minimum 6 characters">
          </div>
          <div class="field-group confirm-field">
            <label for="confirmPassword">Confirm password</label>
            <input id="confirmPassword" name="confirmPassword" type="password" autocomplete="new-password" minlength="6" placeholder="Repeat your password">
          </div>
          <button id="submitBtn" class="primary-btn" type="submit">Continue</button>
        </form>

        <p id="authFeedback" class="feedback hidden" role="status" aria-live="polite"></p>
      </section>

      <section id="boardPanel" class="panel board-panel hidden" aria-live="polite">
        <header>
          <div>
            <h1>Bus board</h1>
            <small>Resets daily. Today: <span id="dayLabel">—</span></small>
          </div>
        </header>

        <div class="board-grid">
          <div class="list-card">
            <h2>On the bus <span id="onCount">0</span></h2>
            <ul id="onList"></ul>
          </div>
          <div class="list-card">
            <h2>Waiting <span id="offCount">0</span></h2>
            <ul id="offList"></ul>
          </div>
        </div>

        <div class="actions">
          <button id="markOnBtn" class="primary-btn" type="button">I'm on the bus</button>
          <button id="leaveBusBtn" class="ghost-btn" type="button">Leave the bus</button>
          <button id="signOutBtn" class="ghost-btn" type="button">Sign out</button>
        </div>

        <p id="boardFeedback" class="feedback hidden"></p>
      </section>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        if (!window.firebase || !firebase.apps.length) {
          console.error('Firebase failed to initialize.');
          return;
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        const shell = document.body;
        const authPanel = document.getElementById('authPanel');
        const boardPanel = document.getElementById('boardPanel');
        const authForm = document.getElementById('authForm');
        const emailField = document.getElementById('email');
        const passwordField = document.getElementById('password');
        const confirmField = document.getElementById('confirmPassword');
        const submitBtn = document.getElementById('submitBtn');
        const authFeedback = document.getElementById('authFeedback');
        const modeButtons = Array.from(document.querySelectorAll('[data-mode-button]'));

        const dayLabel = document.getElementById('dayLabel');
        const onList = document.getElementById('onList');
        const offList = document.getElementById('offList');
        const onCount = document.getElementById('onCount');
        const offCount = document.getElementById('offCount');
        const boardFeedback = document.getElementById('boardFeedback');
        const markOnBtn = document.getElementById('markOnBtn');
        const leaveBusBtn = document.getElementById('leaveBusBtn');
        const signOutBtn = document.getElementById('signOutBtn');

        const modeSettings = {
          signin: {
            button: 'Sign in',
            pending: 'Signing in…',
            copy: 'Use existing credentials to continue.'
          },
          signup: {
            button: 'Create account',
            pending: 'Creating account…',
            copy: 'Provision a new account.'
          },
          reset: {
            button: 'Send reset link',
            pending: 'Sending link…',
            copy: 'Receive a password reset email.'
          }
        };

        markOnBtn.disabled = true;
        leaveBusBtn.disabled = true;
        signOutBtn.disabled = true;

        const state = {
          mode: 'signin',
          loading: false,
          user: null,
          roster: [],
          rosterMap: new Map(),
          members: {},
          membersLoaded: false,
          rosterLoaded: false,
          busActionPending: false,
          rosterUnsub: null,
          dayUnsub: null,
          dayKey: null
        };

        const variants = ['error', 'success', 'info'];

        const setAuthFeedback = (message, variant) => {
          variants.forEach(type => authFeedback.classList.remove('is-' + type));
          if (!message) {
            authFeedback.textContent = '';
            authFeedback.classList.add('hidden');
            return;
          }

          authFeedback.textContent = message;
          authFeedback.classList.remove('hidden');
          if (variant && variants.includes(variant)) {
            authFeedback.classList.add('is-' + variant);
          }
        };

        const setBoardFeedback = (message, variant) => {
          variants.forEach(type => boardFeedback.classList.remove('is-' + type));
          if (!message) {
            boardFeedback.textContent = '';
            boardFeedback.classList.add('hidden');
            return;
          }

          boardFeedback.textContent = message;
          boardFeedback.classList.remove('hidden');
          if (variant && variants.includes(variant)) {
            boardFeedback.classList.add('is-' + variant);
          }
        };

        const setShellState = (isAuthed) => {
          shell.classList.toggle('is-authed', isAuthed);
          shell.classList.toggle('is-guest', !isAuthed);
        };

        const clearLoadingMessageIfReady = () => {
          if (
            state.membersLoaded &&
            state.rosterLoaded &&
            boardFeedback.textContent.trim() === 'Loading roster…'
          ) {
            setBoardFeedback('');
          }
        };

        const refreshPresenceButtons = () => {
          const isAuthed = Boolean(state.user);
          const membershipKnown = isAuthed && state.membersLoaded;
          const isOnBus = membershipKnown && Boolean(state.members && state.members[state.user.uid]);
          const pending = state.busActionPending;
          markOnBtn.disabled = !membershipKnown || isOnBus || pending;
          leaveBusBtn.disabled = !membershipKnown || !isOnBus || pending;
        };

        const setBusActionPending = (pending) => {
          state.busActionPending = pending;
          refreshPresenceButtons();
        };

        const setMode = (mode) => {
          if (!modeSettings[mode]) {
            return;
          }

          state.mode = mode;
          authForm.dataset.mode = mode;
          submitBtn.textContent = modeSettings[mode].button;
          passwordField.value = '';
          confirmField.value = '';
          passwordField.required = mode !== 'reset';
          confirmField.required = mode === 'signup';
          passwordField.setAttribute('autocomplete', mode === 'signup' ? 'new-password' : 'current-password');

          modeButtons.forEach(button => {
            const active = button.dataset.mode === mode;
            button.classList.toggle('active', active);
            button.setAttribute('aria-pressed', active);
          });

          setAuthFeedback('');
        };

        modeButtons.forEach(btn => {
          btn.addEventListener('click', function () {
            if (state.loading) {
              return;
            }
            setMode(btn.dataset.mode);
          });
        });

        const setLoading = (loading) => {
          state.loading = loading;
          submitBtn.disabled = loading;
          emailField.disabled = loading;
          passwordField.disabled = loading && state.mode !== 'reset';
          confirmField.disabled = loading || state.mode !== 'signup';
          modeButtons.forEach(btn => btn.disabled = loading);
          submitBtn.textContent = loading ? modeSettings[state.mode].pending : modeSettings[state.mode].button;
        };

        const readableError = (error) => {
          if (!error || !error.code) {
            return error && error.message ? error.message : 'Unable to complete the request.';
          }

          switch (error.code) {
            case 'auth/email-already-in-use':
              return 'That email is already in use.';
            case 'auth/invalid-email':
              return 'Enter a valid email address.';
            case 'auth/operation-not-allowed':
              return 'This operation is not available.';
            case 'auth/user-disabled':
              return 'This account has been disabled.';
            case 'auth/user-not-found':
              return 'No account found for that email.';
            case 'auth/wrong-password':
              return 'The password you entered is incorrect.';
            case 'auth/weak-password':
              return 'Use at least six characters.';
            case 'auth/too-many-requests':
              return 'Too many attempts. Please wait and try again.';
            case 'permission-denied':
              return 'You do not have permission to perform that action.';
            case 'unavailable':
              return 'Service unavailable. Please try again.';
            default:
              return error.message.replace('Firebase: ', '');
          }
        };

        authForm.addEventListener('submit', function (event) {
          event.preventDefault();
          if (state.loading) {
            return;
          }

          const email = emailField.value.trim();
          const password = passwordField.value;
          const confirmPassword = confirmField.value;

          if (!email) {
            setAuthFeedback('Enter an email address.', 'error');
            return;
          }

          if (state.mode !== 'reset' && !password) {
            setAuthFeedback('Enter your password.', 'error');
            return;
          }

          if (state.mode === 'signup' && password !== confirmPassword) {
            setAuthFeedback('Passwords must match.', 'error');
            return;
          }

          setLoading(true);
          setAuthFeedback(modeSettings[state.mode].pending, 'info');

          let action;
          if (state.mode === 'signin') {
            action = auth.signInWithEmailAndPassword(email, password);
          } else if (state.mode === 'signup') {
            action = auth.createUserWithEmailAndPassword(email, password);
          } else {
            action = auth.sendPasswordResetEmail(email);
          }

          action.then(() => {
            if (state.mode === 'reset') {
              setAuthFeedback('If an account exists for that email, a reset link was sent.', 'success');
              authForm.reset();
              setMode('signin');
            }
          }).catch(error => {
            setAuthFeedback(readableError(error), 'error');
          }).finally(() => {
            setLoading(false);
          });
        });

        const getDayKey = (date = new Date()) => date.toLocaleDateString('en-CA');
        const formatDayLabel = (date = new Date()) => new Intl.DateTimeFormat('en-US', {
          weekday: 'short', month: 'short', day: 'numeric'
        }).format(date);

        const updateDayListener = () => {
          const newKey = getDayKey();
          if (state.dayKey === newKey) {
            return;
          }

          state.dayKey = newKey;
          state.membersLoaded = false;
          state.busActionPending = false;
          refreshPresenceButtons();
          dayLabel.textContent = formatDayLabel();

          if (state.dayUnsub) {
            state.dayUnsub();
            state.dayUnsub = null;
          }

          if (!state.user) {
            return;
          }

          const dayRef = db.collection('busDays').doc(state.dayKey);
          state.dayUnsub = dayRef.onSnapshot(snapshot => {
            const data = snapshot.exists ? snapshot.data() : {};
            state.members = data.members || {};
            state.membersLoaded = true;
            renderBoard();
          }, error => {
            console.error(error);
            setBoardFeedback('Unable to load today\'s board.', 'error');
          });
        };

        setInterval(updateDayListener, 60000);
        updateDayListener();

        const attachRosterListener = () => {
          if (state.rosterUnsub) {
            return;
          }

          state.rosterLoaded = false;
          state.rosterUnsub = db.collection('passengers').orderBy('label').onSnapshot(snapshot => {
            state.roster = [];
            state.rosterMap.clear();
            snapshot.forEach(doc => {
              const entry = { id: doc.id, ...(doc.data() || {}) };
              entry.label = entry.label || entry.email || doc.id;
              entry.userId = entry.userId || doc.id;
              state.roster.push(entry);
              state.rosterMap.set(entry.userId, entry);
            });
            state.rosterLoaded = true;
            renderBoard();
            clearLoadingMessageIfReady();
          }, error => {
            console.error(error);
          });
        };

        const detachRosterListener = () => {
          if (state.rosterUnsub) {
            state.rosterUnsub();
            state.rosterUnsub = null;
          }
          state.rosterLoaded = false;
          clearLoadingMessageIfReady();
        };

        const clearDayListener = () => {
          if (state.dayUnsub) {
            state.dayUnsub();
            state.dayUnsub = null;
          }
          state.membersLoaded = false;
          state.members = {};
          state.busActionPending = false;
          refreshPresenceButtons();
        };

        const renderBoard = () => {
          if (!state.user) {
            return;
          }

          onList.innerHTML = '';
          offList.innerHTML = '';

          const entries = state.roster.length ? state.roster : [];
          const onEntries = [];
          const offEntries = [];

          entries.forEach(person => {
            const memberKey = person.userId || person.id;
            const member = state.members ? state.members[memberKey] : undefined;
            if (member) {
              onEntries.push({ person, member });
            } else {
              offEntries.push({ person });
            }
          });

          if (!onEntries.length) {
            const placeholder = document.createElement('li');
            placeholder.className = 'dim-text';
            placeholder.textContent = 'No one on the bus yet.';
            onList.appendChild(placeholder);
          } else {
            onEntries.forEach(({ person, member }) => {
              const item = document.createElement('li');
              item.textContent = person.label || person.email || 'Unnamed';
              if (member && member.updatedAt && member.updatedAt.toDate) {
                const time = document.createElement('span');
                time.className = 'dim-text';
                time.textContent = new Intl.DateTimeFormat('en-US', {
                  hour: '2-digit', minute: '2-digit'
                }).format(member.updatedAt.toDate());
                item.appendChild(time);
              }
              onList.appendChild(item);
            });
          }

          if (!offEntries.length) {
            const placeholder = document.createElement('li');
            placeholder.className = 'dim-text';
            placeholder.textContent = entries.length ? 'Everyone is on board.' : 'Add people to the roster.';
            offList.appendChild(placeholder);
          } else {
            offEntries.forEach(({ person }) => {
              const item = document.createElement('li');
              item.textContent = person.label || person.email || 'Unnamed';
              offList.appendChild(item);
            });
          }

          onCount.textContent = onEntries.length;
          offCount.textContent = offEntries.length;

          refreshPresenceButtons();
          clearLoadingMessageIfReady();
        };

        const ensureRosterEntry = async (user) => {
          if (!user) {
            return;
          }

          const passengersRef = db.collection('passengers');
          const personalDocRef = passengersRef.doc(user.uid);
          const personalDoc = await personalDocRef.get();

          if (personalDoc.exists) {
            if (!personalDoc.data().userId) {
              await personalDocRef.set({ userId: user.uid }, { merge: true });
            }
            return;
          }

          // Legacy records might have been created with a custom document ID.
          if (user.email) {
            const legacySnapshot = await passengersRef.where('email', '==', user.email).limit(1).get();
            if (!legacySnapshot.empty) {
              await legacySnapshot.docs[0].ref.set({ userId: user.uid }, { merge: true });
              return;
            }
          }

          await personalDocRef.set({
            label: user.displayName || (user.email ? user.email.split('@')[0] : 'User'),
            email: user.email || '',
            userId: user.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        };

        const updatePresence = (isOnBus) => {
          if (!state.user) {
            return;
          }

          if (!state.dayKey) {
            setBoardFeedback('Preparing today\'s board…', 'info');
            updateDayListener();
            return;
          }

          const dayRef = db.collection('busDays').doc(state.dayKey);
          const memberPath = 'members.' + state.user.uid;
          const label = (state.rosterMap.get(state.user.uid) || {}).label || state.user.email || 'Unnamed';

          const payload = isOnBus
            ? {
                [memberPath]: {
                  label,
                  email: state.user.email || '',
                  userId: state.user.uid,
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              }
            : {
                [memberPath]: firebase.firestore.FieldValue.delete(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              };

          setBusActionPending(true);
          setBoardFeedback(isOnBus ? 'Updating status…' : 'Clearing status…', 'info');

          dayRef.set(payload, { merge: true })
            .then(() => {
              setBoardFeedback(isOnBus ? 'Marked as on the bus.' : 'Marked as waiting.', 'success');
              if (isOnBus) {
                state.members = state.members || {};
                state.members[state.user.uid] = {
                  label,
                  email: state.user.email || '',
                  userId: state.user.uid,
                  updatedAt: firebase.firestore.Timestamp.now()
                };
              } else if (state.members && state.members[state.user.uid]) {
                delete state.members[state.user.uid];
              }
              renderBoard();
            })
            .catch(error => {
              console.error(error);
              setBoardFeedback(readableError(error), 'error');
            })
            .finally(() => {
              setBusActionPending(false);
            });
        };

        markOnBtn.addEventListener('click', () => updatePresence(true));
        leaveBusBtn.addEventListener('click', () => updatePresence(false));

        signOutBtn.addEventListener('click', () => {
          signOutBtn.disabled = true;
          setBoardFeedback('Signing out…', 'info');
          auth.signOut().catch(error => {
            console.error(error);
            setBoardFeedback(readableError(error), 'error');
            signOutBtn.disabled = false;
          });
        });

        setShellState(false);
        setMode('signin');
        state.membersLoaded = false;
        state.rosterLoaded = false;
        state.busActionPending = false;
        refreshPresenceButtons();

        auth.onAuthStateChanged(async function (user) {
          state.user = user || null;

          const isAuthed = Boolean(user);
          setShellState(isAuthed);

          if (user) {
            authPanel.classList.add('hidden');
            boardPanel.classList.remove('hidden');
            setBoardFeedback('Loading roster…', 'info');
            await ensureRosterEntry(user);
            attachRosterListener();
            updateDayListener();
            refreshPresenceButtons();
            signOutBtn.disabled = false;
          } else {
            authForm.reset();
            setMode('signin');
            authPanel.classList.remove('hidden');
            boardPanel.classList.add('hidden');
            detachRosterListener();
            clearDayListener();
            state.members = {};
            state.dayKey = null;
            state.membersLoaded = false;
            setBoardFeedback('');
            state.roster = [];
            state.rosterMap.clear();
            onList.innerHTML = '';
            offList.innerHTML = '';
            onCount.textContent = '0';
            offCount.textContent = '0';
            refreshPresenceButtons();
            signOutBtn.disabled = true;
          }
        });
      });
    </script>
  </body>
</html>
